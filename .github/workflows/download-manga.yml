name: ğŸ“š MangaDex Downloader â†’ Telegram

on:
  workflow_dispatch:
    inputs:
      manga_link:
        description: 'ğŸ”— MangaDex manga URL or UUID'
        required: true
        type: string
        example: 'https://mangadex.org/title/123e4567-e89b-12d3-a456-426614174000'
      
      use_data_saver:
        description: 'ğŸ—œï¸ Use compressed images (smaller size, lower quality)'
        required: false
        type: boolean
        default: false
      
      max_chapters:
        description: 'ğŸ“– Maximum chapters to download (1-100)'
        required: false
        type: number
        default: 10
        minimum: 1
        maximum: 1000
      
      upload_to_telegram:
        description: 'ğŸ“¤ Upload chapters to Telegram channel'
        required: false
        type: boolean
        default: true
      
      upload_to_github:
        description: 'ğŸ’¾ Also save ZIPs to GitHub repository'
        required: false
        type: boolean
        default: false
      
      target_branch:
        description: 'ğŸŒ¿ Branch to push results to (if GitHub upload enabled)'
        required: false
        type: string
        default: 'main'

  # Optional: Schedule automatic downloads (uncomment to enable)
  # schedule:
  #   - cron: '0 12 * * 0'  # Every Sunday at 12:00 UTC

jobs:
  download-and-upload:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write  # Required only if upload_to_github = true
    
    steps:
      # ğŸ›¡ï¸ Validate inputs early
      - name: Validate configuration
        run: |
          if [[ "${{ inputs.upload_to_telegram }}" == "false" && "${{ inputs.upload_to_github }}" == "false" ]]; then
            echo "âŒ Error: At least one upload destination must be enabled"
            exit 1
          fi
          if [[ "${{ inputs.upload_to_telegram }}" == "true" && -z "${{ secrets.TELEGRAM_BOT_TOKEN }}" ]]; then
            echo "âŒ Error: TELEGRAM_BOT_TOKEN secret is required for Telegram upload"
            exit 1
          fi

      # ğŸ“¦ Checkout repository
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4
        with:
          persist-credentials: ${{ inputs.upload_to_github }}
          fetch-depth: 0

      # ğŸŸ¢ Setup Node.js environment
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # ğŸ“¥ Install dependencies
      - name: ğŸ“¥ Install dependencies
        run: npm install

      # ğŸ—‚ï¸ Prepare working directory
      - name: ğŸ—‚ï¸ Prepare directories
        run: |
          mkdir -p manga_download/chapters
          mkdir -p result

      # ğŸ”„ Download manga with Telegram integration
      - name: ğŸ”„ Download manga
        id: download
        env:
          # MangaDex configuration
          MANGA_INPUT: ${{ inputs.manga_link }}
          USE_DATA_SAVER: ${{ inputs.use_data_saver }}
          MAX_CHAPTERS: ${{ inputs.max_chapters }}
          
          # Telegram configuration (only if enabled)
          TELEGRAM_BOT_TOKEN: ${{ inputs.upload_to_telegram && secrets.TELEGRAM_BOT_TOKEN || '' }}
          TELEGRAM_CHAT_ID: ${{ inputs.upload_to_telegram && secrets.TELEGRAM_CHAT_ID || '' }}
          
          # GitHub configuration (only if enabled)
          GITHUB_UPLOAD: ${{ inputs.upload_to_github }}
          GITHUB_TOKEN: ${{ inputs.upload_to_github && secrets.GITHUB_TOKEN || '' }}
        run: |
          echo "ğŸš€ Starting manga download..."
          echo "ğŸ”— Source: ${{ inputs.manga_link }}"
          echo "ğŸ—œï¸ Data Saver: ${{ inputs.use_data_saver }}"
          echo "ğŸ“– Max Chapters: ${{ inputs.max_chapters }}"
          echo "ğŸ“¤ Telegram: ${{ inputs.upload_to_telegram }}"
          echo "ğŸ’¾ GitHub: ${{ inputs.upload_to_github }}"
          echo ""
          
          npm run download
          
          # Capture output for summary
          if [[ -f manga_download/summary.txt ]]; then
            echo "summary<<EOF" >> $GITHUB_OUTPUT
            cat manga_download/summary.txt >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      # ğŸ“¤ Upload to GitHub (if enabled)
      - name: ğŸ“¤ Upload to GitHub repository
        if: inputs.upload_to_github == true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TARGET_BRANCH: ${{ inputs.target_branch }}
        run: |
          echo "ğŸ’¾ Preparing GitHub upload..."
          
          # Configure git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Move any remaining ZIPs to result folder
          find manga_download -name "*.zip" -exec mv {} result/ \; 2>/dev/null || true
          
          # Skip if nothing to upload
          if [[ ! -n "$(ls -A result 2>/dev/null)" ]]; then
            echo "âš ï¸ No files to upload to GitHub"
            exit 0
          fi
          
          # Add, commit, and push
          git add result/
          git commit -m "ğŸ“š Download: $(basename result/*.zip 2>/dev/null | head -1)
          
          - Source: ${{ inputs.manga_link }}
          - Chapters: ${{ inputs.max_chapters }}
          - Data Saver: ${{ inputs.use_data_saver }}
          - Generated: $(date -u +"%Y-%m-%d %H:%M UTC")
          
          [skip ci]" || echo "âš ï¸ No changes to commit"
          
          git push origin "${TARGET_BRANCH}"
          
          echo "âœ… Uploaded to GitHub: ${TARGET_BRANCH}/result"

      # ğŸ“Š Generate run summary
      - name: ğŸ“Š Generate summary
        run: |
          {
            echo "## ğŸ‰ Download Complete"
            echo ""
            echo "### ğŸ“š Manga Info"
            echo "- **Source**: ${{ inputs.manga_link }}"
            echo "- **Chapters**: ${{ inputs.max_chapters }} (max)"
            echo "- **Data Saver**: ${{ inputs.use_data_saver && 'âœ… Yes' || 'âŒ No' }}"
            echo ""
            echo "### ğŸ“¤ Upload Status"
            echo "- **Telegram**: ${{ inputs.upload_to_telegram && 'âœ… Sent' || 'â­ï¸ Skipped' }}"
            echo "- **GitHub**: ${{ inputs.upload_to_github && 'âœ… Pushed' || 'â­ï¸ Skipped' }}"
            echo ""
            
            # Show downloaded files if any exist locally
            if [[ -d result && -n "$(ls -A result 2>/dev/null)" ]]; then
              echo "### ğŸ“¦ Generated Files"
              echo '```'
              ls -lh result/*.zip 2>/dev/null | awk '{print "- "$9" ("$5")"}' || echo "- No files found"
              echo '```'
            fi
            echo ""
            echo "### ğŸ”— Quick Links"
            if [[ "${{ inputs.upload_to_github }}" == "true" ]]; then
              echo "- [ğŸ“ View in Repository](${{ github.server_url }}/${{ github.repository }}/tree/${{ inputs.target_branch }}/result)"
            fi
            if [[ "${{ inputs.upload_to_telegram }}" == "true" ]]; then
              echo "- [ğŸ’¬ Check Telegram Channel](https://t.me/c/$(echo ${{ secrets.TELEGRAM_CHAT_ID }} | sed 's/-100//')/)"
            fi
          } >> $GITHUB_STEP_SUMMARY

      # ğŸ§¹ Cleanup workspace
      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up workspace..."
          rm -rf manga_download node_modules
          echo "âœ… Cleanup complete"

      # âŒ Error notification (if download failed)
      - name: âŒ Notify on failure
        if: failure() && inputs.upload_to_telegram == true
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [[ -n "$TELEGRAM_BOT_TOKEN" && -n "$TELEGRAM_CHAT_ID" ]]; then
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
              -H "Content-Type: application/json" \
              -d "{
                \"chat_id\": \"$TELEGRAM_CHAT_ID\",
                \"text\": \"âŒ <b>Download Failed</b>\\n\\n<b>Workflow</b>: ${{ github.workflow }}\\n<b>Run</b>: ${{ github.run_number }}\\n<b>Manga</b>: <code>${{ inputs.manga_link }}</code>\\n\\n[View Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\",
                \"parse_mode\": \"HTML\"
              }" || true
          fi

  # ğŸ”„ Optional: Auto-delete old workflow runs to save space
  cleanup-old-runs:
    needs: download-and-upload
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'schedule'
    permissions:
      actions: write
    steps:
      - name: ğŸ—‘ï¸ Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 7
          keep_minimum_runs: 3
