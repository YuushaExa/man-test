name: Download Manga & Upload to Telegram

on:
  workflow_dispatch:
    inputs:
      manga_link:
        description: 'MangaDex manga URL or UUID (e.g., https://mangadex.org/title/xxx or just UUID)'
        required: true
        type: string
        placeholder: 'https://mangadex.org/title/123e4567-e89b-12d3-a456-426614174000'
      
      use_data_saver:
        description: 'Use compressed images (smaller file size, lower quality)'
        required: false
        type: boolean
        default: true
      
      max_chapters:
        description: 'Maximum number of chapters to download'
        required: false
        type: number
        default: 10
      
      upload_artwork:
        description: 'Upload additional artwork images (if available)'
        required: false
        type: boolean
        default: false
      
      bundle_size_mb:
        description: 'Maximum bundle size in MB (chapters will be combined to stay under this)'
        required: false
        type: number
        default: 49

jobs:
  download-and-upload:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üì¶ Install dependencies
        run: npm install

      - name: üìö Download manga chapters
        id: download
        env:
          MANGA_INPUT: ${{ inputs.manga_link }}
          USE_DATA_SAVER: ${{ inputs.use_data_saver }}
          MAX_CHAPTERS: ${{ inputs.max_chapters }}
          UPLOAD_ARTWORK: ${{ inputs.upload_artwork }}
          BUNDLE_SIZE_MB: ${{ inputs.bundle_size_mb }}
        run: npm run download

      - name: üì§ Upload to Telegram
        id: upload
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: npm run upload

      - name: üßπ Cleanup temporary files
        if: always()
        run: |
          echo "Cleaning up temporary files..."
          rm -rf temp/
          rm -rf node_modules/
          echo "‚úÖ Cleanup complete"

      - name: üìä Upload summary
        run: |
          echo "## ‚úÖ Manga Download & Upload Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Manga:** ${{ inputs.manga_link }}" >> $GITHUB_STEP_SUMMARY
          echo "**Data Saver:** ${{ inputs.use_data_saver }}" >> $GITHUB_STEP_SUMMARY
          echo "**Max Chapters:** ${{ inputs.max_chapters }}" >> $GITHUB_STEP_SUMMARY
          echo "**Bundle Size:** ${{ inputs.bundle_size_mb }} MB" >> $GITHUB_STEP_SUMMARY
          echo "**Upload Artwork:** ${{ inputs.upload_artwork }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üì± Check your Telegram channel/chat for the uploaded manga!" >> $GITHUB_STEP_SUMMARY

      - name: ‚ö†Ô∏è Error notification (on failure)
        if: failure()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              -d text="‚ùå **Manga Download Failed**

              **Manga:** ${{ inputs.manga_link }}
              **Time:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
              **Workflow:** ${{ github.workflow }}
              **Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

              Check the workflow logs for details." \
              -d parse_mode="Markdown" || true
          fi
