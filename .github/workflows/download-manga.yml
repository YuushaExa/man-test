name: Download Manga from MangaDex

on:
  workflow_dispatch:
    inputs:
      manga_link:
        description: 'MangaDex manga URL or UUID'
        required: true
        type: string
        example: 'https://mangadex.org/title/123e4567-e89b-12d3-a456-426614174000'
      
      use_data_saver:
        description: 'Use compressed images (smaller size, lower quality)'
        required: false
        type: boolean
        default: false
      
      max_chapters:
        description: 'Maximum chapters to download'
        required: false
        type: number
        default: 10
      
      target_branch:
        description: 'Branch to push results to (default: current branch)'
        required: false
        type: string
        default: ''

jobs:
  download:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # üîê Required to push commits
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true  # Keep GITHUB_TOKEN for pushing
          fetch-depth: 0  # Fetch all history for proper commits

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Download manga
        id: download
        env:
          MANGA_INPUT: ${{ inputs.manga_link }}
          USE_DATA_SAVER: ${{ inputs.use_data_saver }}
          MAX_CHAPTERS: ${{ inputs.max_chapters }}
        run: npm run download

      - name: Read zip name
        id: zipname
        run: echo "name=$(cat manga_download/zip_name.txt)" >> $GITHUB_OUTPUT

      - name: Prepare result folder
        run: |
          mkdir -p result
          # Move zip to result folder
          mv manga_download/*.zip result/
          # Clean up temporary files
          rm -rf manga_download

      - name: Commit and push results
        env:
          ZIP_NAME: ${{ steps.zipname.outputs.name }}
          TARGET_BRANCH: ${{ inputs.target_branch }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Configure git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Determine target branch
          BRANCH="${TARGET_BRANCH:-$(git branch --show-current)}"
          echo "üì¶ Pushing to branch: $BRANCH"
          
          # Add, commit, and push
          git add result/
          git commit -m "üìö Add manga: $ZIP_NAME

          Downloaded via GitHub Actions
          - Source: ${{ inputs.manga_link }}
          - Data Saver: ${{ inputs.use_data_saver }}
          - Chapters: ${{ inputs.max_chapters }}
          
          [skip ci]" || echo "‚ö†Ô∏è No changes to commit"
          
          git push origin "$BRANCH"

      - name: Summary
        run: |
          echo "‚úÖ Download and upload complete!"
          echo "üì¶ File: **result/${{ steps.zipname.outputs.name }}**"
          echo "üîó View in repo: \`$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/tree/$(git branch --show-current)/result\`"
